package domain

import (
	"fmt"
	"time"
)

// Severity representation helper (1-10)
type Severity int

const (
	VulnSeverityCritical Severity = 10
	VulnSeverityHigh     Severity = 8
	VulnSeverityMedium   Severity = 5
	VulnSeverityLow      Severity = 3
	VulnSeverityInfo     Severity = 1
)

func (s Severity) String() string {
	switch {
	case s >= VulnSeverityCritical:
		return "CRITICAL"
	case s >= VulnSeverityHigh:
		return "HIGH"
	case s >= VulnSeverityMedium:
		return "MEDIUM"
	case s >= VulnSeverityLow:
		return "LOW"
	default:
		return "INFO"
	}
}

// Confidence type-safe float for certainty (0.0 - 1.0)
type Confidence float64

// Confidence levels constants
const (
	ConfidenceConfirmed   Confidence = 1.0 // Direct evidence in packets
	ConfidenceHigh        Confidence = 0.8 // Strong indicators
	ConfidenceMedium      Confidence = 0.5 // Reasonable inference
	ConfidenceLow         Confidence = 0.3 // Weak inference
	ConfidenceSpeculative Confidence = 0.1 // Pure speculation
)

// VulnerabilityStatus represents the lifecycle state of a vulnerability
type VulnerabilityStatus string

const (
	VulnStatusActive  VulnerabilityStatus = "active"
	VulnStatusIgnored VulnerabilityStatus = "ignored"
	VulnStatusFixed   VulnerabilityStatus = "fixed"
)

// VulnerabilityTag represents a detection event
type VulnerabilityTag struct {
	Name        string     `json:"name"`
	Severity    Severity   `json:"severity"`
	Confidence  Confidence `json:"confidence"`
	Description string     `json:"description"`
	Evidence    []string   `json:"evidence"`
	Category    string     `json:"category"`
	Mitigation  string     `json:"mitigation"`
	DetectedAt  time.Time  `json:"detected_at"`
}

// VulnerabilityRecord represents a persistent vulnerability entry for a device
type VulnerabilityRecord struct {
	ID              string              `json:"id"`
	DeviceMAC       string              `json:"device_mac"`
	Name            string              `json:"name"`
	Severity        Severity            `json:"severity"`
	Confidence      Confidence          `json:"confidence"`
	Description     string              `json:"description"`
	Evidence        []string            `json:"evidence"`
	Status          VulnerabilityStatus `json:"status"`
	StatusChangedAt time.Time           `json:"status_changed_at"`
	FirstSeen       time.Time           `json:"first_seen"`
	LastSeen        time.Time           `json:"last_seen"`
	Notes           string              `json:"notes"`
}

// NewVulnerabilityRecord initializes a record from a detection tag
func NewVulnerabilityRecord(deviceMAC string, tag VulnerabilityTag) *VulnerabilityRecord {
	now := time.Now()
	return &VulnerabilityRecord{
		ID:              fmt.Sprintf("%s-%s", deviceMAC, tag.Name),
		DeviceMAC:       deviceMAC,
		Name:            tag.Name,
		Severity:        tag.Severity,
		Confidence:      tag.Confidence,
		Description:     tag.Description,
		Evidence:        tag.Evidence,
		Status:          VulnStatusActive,
		StatusChangedAt: now,
		FirstSeen:       tag.DetectedAt,
		LastSeen:        tag.DetectedAt,
	}
}

// MarkAsFixed transitions the vulnerability to fixed state
func (v *VulnerabilityRecord) MarkAsFixed() {
	v.Status = VulnStatusFixed
	v.StatusChangedAt = time.Now()
}

// MarkAsIgnored transitions the vulnerability to ignored state
func (v *VulnerabilityRecord) MarkAsIgnored() {
	v.Status = VulnStatusIgnored
	v.StatusChangedAt = time.Now()
}

// SeverityType returns the Severity named type for the record's priority
func (v *VulnerabilityRecord) SeverityType() Severity {
	return Severity(v.Severity)
}

// UpdateLastSeen updates the timestamp and optionally merges evidence
func (v *VulnerabilityRecord) UpdateLastSeen(seenAt time.Time, newEvidence []string) {
	v.LastSeen = seenAt
	if len(newEvidence) > 0 {
		v.Evidence = append(v.Evidence, newEvidence...)
	}
}

// ConfirmationSource represents the source of vulnerability confirmation
type ConfirmationSource string

const (
	ConfirmationSourceWPSAttack    ConfirmationSource = "wps-attack"
	ConfirmationSourceDeauthAttack ConfirmationSource = "deauth-attack"
	ConfirmationSourcePMKIDCapture ConfirmationSource = "pmkid-capture"
	ConfirmationSourceManual       ConfirmationSource = "manual"
)

// VulnerabilityConfirmation represents an event when a vulnerability is confirmed via active validation
type VulnerabilityConfirmation struct {
	VulnerabilityName string             `json:"vulnerability_name"`
	DeviceMAC         string             `json:"device_mac"`
	ConfirmedBy       ConfirmationSource `json:"confirmed_by"`
	Evidence          map[string]string  `json:"evidence"`
	ConfirmedAt       time.Time          `json:"confirmed_at"`
	AttackID          string             `json:"attack_id,omitempty"`
}

// VulnerabilityFilter defines criteria for querying vulnerabilities
type VulnerabilityFilter struct {
	Status      *VulnerabilityStatus
	MinSeverity int
	DeviceMAC   string
}

// ConfirmWithEvidence updates the vulnerability record with confirmation details
func (v *VulnerabilityRecord) ConfirmWithEvidence(confirmation VulnerabilityConfirmation) {
	v.Confidence = ConfidenceConfirmed
	v.LastSeen = confirmation.ConfirmedAt

	// Add confirmation evidence
	for key, value := range confirmation.Evidence {
		evidenceStr := fmt.Sprintf("%s: %s (confirmed by %s)", key, value, confirmation.ConfirmedBy)
		v.Evidence = append(v.Evidence, evidenceStr)
	}

	// Update notes with confirmation details
	if v.Notes != "" {
		v.Notes += "\n"
	}
	v.Notes += fmt.Sprintf("Confirmed via %s at %s", confirmation.ConfirmedBy, confirmation.ConfirmedAt.Format(time.RFC3339))
}
