package security_test

import (
	"testing"

	"github.com/lcalzada-xor/wmap/internal/core/domain"
	"github.com/lcalzada-xor/wmap/internal/core/services/security"
	"github.com/stretchr/testify/assert"
)

func TestVulnerabilityDetector_DetectVulnerabilities(t *testing.T) {
	vd := security.NewVulnerabilityDetector(nil) // Registry not needed for current rules

	t.Run("Detects WEP", func(t *testing.T) {
		dev := &domain.Device{
			Type:     domain.DeviceTypeAP,
			Security: "WEP",
		}
		tags := vd.DetectVulnerabilities(dev)
		assert.NotEmpty(t, tags)
		assert.Equal(t, "WEP", tags[0].Name)
		assert.Equal(t, domain.VulnSeverityCritical, tags[0].Severity)
	})

	t.Run("Detects TKIP", func(t *testing.T) {
		dev := &domain.Device{
			Type:     domain.DeviceTypeAP,
			Security: "WPA2",
			RSNInfo: &domain.RSNInfo{
				PairwiseCiphers: []string{"TKIP"},
			},
		}
		tags := vd.DetectVulnerabilities(dev)
		found := false
		for _, tag := range tags {
			if tag.Name == "TKIP" {
				found = true
				break
			}
		}
		assert.True(t, found)
	})

	t.Run("Detects NO-PMF on WPA2", func(t *testing.T) {
		dev := &domain.Device{
			Type:     domain.DeviceTypeAP,
			Security: "WPA2",
			RSNInfo: &domain.RSNInfo{
				Capabilities: domain.RSNCapabilities{
					MFPRequired: false,
				},
			},
		}
		tags := vd.DetectVulnerabilities(dev)
		found := false
		for _, tag := range tags {
			if tag.Name == "NO-PMF" {
				found = true
				break
			}
		}
		assert.True(t, found)
	})

	t.Run("Detects WPA3 Transition Mode", func(t *testing.T) {
		dev := &domain.Device{
			Type:     domain.DeviceTypeAP,
			Security: "WPA3",
			RSNInfo: &domain.RSNInfo{
				AKMSuites: []string{"PSK", "SAE"},
			},
		}
		tags := vd.DetectVulnerabilities(dev)
		found := false
		for _, tag := range tags {
			if tag.Name == "WPA3-TRANSITION" {
				found = true
				break
			}
		}
		assert.True(t, found)
	})

	t.Run("Detects WPS-PIXIE", func(t *testing.T) {
		dev := &domain.Device{
			Type: domain.DeviceTypeAP,
			WPSDetails: &domain.WPSDetails{
				Version: "1.0",
				Locked:  false,
			},
		}
		tags := vd.DetectVulnerabilities(dev)
		found := false
		for _, tag := range tags {
			if tag.Name == "WPS-PIXIE" {
				found = true
				break
			}
		}
		assert.True(t, found)
	})
	t.Run("Detects FT-PSK", func(t *testing.T) {
		dev := &domain.Device{
			Type:     domain.DeviceTypeAP,
			Security: "WPA2",
			RSNInfo: &domain.RSNInfo{
				AKMSuites: []string{"FT-PSK"},
			},
			MobilityDomain: &domain.MobilityDomain{
				MDID: 123,
			},
		}
		tags := vd.DetectVulnerabilities(dev)
		found := false
		for _, tag := range tags {
			if tag.Name == "FT-PSK" {
				found = true
				break
			}
		}
		assert.True(t, found)
	})
}
