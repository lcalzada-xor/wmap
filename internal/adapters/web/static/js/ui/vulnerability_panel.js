/**
 * Vulnerability Panel Component
 * Displays a detailed list of detected vulnerabilities.
 */

export class VulnerabilityPanel {
    constructor() {
        this.container = null;
        this.vulns = [];
    }

    render(nodes) {
        // Collect all vulnerabilities from nodes
        const allVulns = [];
        nodes.forEach(node => {
            if (node.vulnerabilities && node.vulnerabilities.length > 0) {
                node.vulnerabilities.forEach(v => {
                    allVulns.push({
                        ...v,
                        deviceMAC: node.mac,
                        deviceName: node.label.split('\n')[0]
                    });
                });
            }
        });

        // Filter and sort
        this.vulns = allVulns.sort((a, b) => b.severity - a.severity);

        if (!this.container) {
            this.createContainer();
        }

        this.updateUI();
    }

    createContainer() {
        this.container = document.createElement('div');
        this.container.id = 'vulnerability-panel';
        this.container.className = 'glass-panel floating-window';
        this.container.style.display = 'none';
        this.container.innerHTML = `
            <div class="panel-header">
                <h3><i class="fas fa-shield-virus"></i> Vulnerabilities</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="panel-content">
                <div id="vuln-list"></div>
            </div>
        `;

        document.body.appendChild(this.container);

        this.container.querySelector('.close-btn').onclick = () => {
            this.container.style.display = 'none';
        };
    }

    updateUI() {
        const list = this.container.querySelector('#vuln-list');
        if (this.vulns.length === 0) {
            list.innerHTML = '<p class="empty-msg">No vulnerabilities detected yet.</p>';
            return;
        }

        list.innerHTML = '';
        this.vulns.forEach(v => {
            const item = document.createElement('div');
            item.className = `vuln-item severity-${this.getSeverityClass(v.severity)}`;

            // Safe rendering using textContent
            const nameSpan = document.createElement('span');
            nameSpan.className = 'vuln-name';
            nameSpan.textContent = v.name;

            const badgeSpan = document.createElement('span');
            badgeSpan.className = 'vuln-badge confidence-badge';
            badgeSpan.textContent = `${(v.confidence * 100).toFixed(0)}% Conf.`;

            const deviceSpan = document.createElement('span');
            deviceSpan.className = 'vuln-device';
            deviceSpan.textContent = `${v.deviceName} (${v.deviceMAC})`;

            const mainDiv = document.createElement('div');
            mainDiv.className = 'vuln-main';
            mainDiv.appendChild(nameSpan);
            mainDiv.appendChild(badgeSpan);
            mainDiv.appendChild(deviceSpan);

            const descP = document.createElement('p');
            descP.className = 'vuln-desc';
            descP.textContent = v.description;

            const mitigDiv = document.createElement('div');
            mitigDiv.className = 'vuln-mitigation';
            mitigDiv.innerHTML = '<strong>Mitigation:</strong> '; // Static HTML is safe
            const mitigText = document.createTextNode(v.mitigation);
            mitigDiv.appendChild(mitigText);

            const evDiv = document.createElement('div');
            evDiv.className = 'vuln-evidence';
            evDiv.innerHTML = '<strong>Evidence:</strong> ';
            const evText = document.createTextNode(v.evidence.join(', '));
            evDiv.appendChild(evText);

            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'vuln-details';
            detailsDiv.appendChild(descP);
            detailsDiv.appendChild(mitigDiv);
            detailsDiv.appendChild(evDiv);

            item.appendChild(mainDiv);
            item.appendChild(detailsDiv);
            list.appendChild(item);
        });
    }

    getSeverityClass(severity) {
        if (severity >= 9) return 'critical';
        if (severity >= 7) return 'high';
        if (severity >= 5) return 'medium';
        return 'low';
    }

    toggle() {
        if (!this.container) this.createContainer();
        this.container.style.display = this.container.style.display === 'none' ? 'block' : 'none';
    }
}
