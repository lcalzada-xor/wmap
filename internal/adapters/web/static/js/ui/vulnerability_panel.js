/**
 * Vulnerability Panel Component
 * Displays a detailed list of detected vulnerabilities.
 */

export class VulnerabilityPanel {
    constructor() {
        this.container = null;
        this.vulns = [];
    }

    render(nodes) {
        // Collect all vulnerabilities from nodes
        const allVulns = [];
        nodes.forEach(node => {
            if (node.vulnerabilities && node.vulnerabilities.length > 0) {
                node.vulnerabilities.forEach(v => {
                    allVulns.push({
                        ...v,
                        deviceMAC: node.mac,
                        deviceName: node.label.split('\n')[0]
                    });
                });
            }
        });

        // Filter and sort
        this.vulns = allVulns.sort((a, b) => b.severity - a.severity);

        if (!this.container) {
            this.createContainer();
        }

        this.updateUI();
    }

    createContainer() {
        this.container = document.createElement('div');
        this.container.id = 'vulnerability-panel';
        this.container.className = 'glass-panel floating-window';
        this.container.style.display = 'none';
        this.container.innerHTML = `
            <div class="panel-header">
                <h3><i class="fas fa-shield-virus"></i> Vulnerabilities</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="panel-content">
                <div id="vuln-list"></div>
            </div>
        `;

        document.body.appendChild(this.container);

        this.container.querySelector('.close-btn').onclick = () => {
            this.container.style.display = 'none';
        };
    }

    updateUI() {
        const list = this.container.querySelector('#vuln-list');
        if (this.vulns.length === 0) {
            list.innerHTML = '<p class="empty-msg">No vulnerabilities detected yet.</p>';
            return;
        }

        list.innerHTML = this.vulns.map(v => `
            <div class="vuln-item severity-${this.getSeverityClass(v.severity)}">
                <div class="vuln-main">
                    <span class="vuln-name">${v.name}</span>
                    <span class="vuln-badge confidence-badge">${(v.confidence * 100).toFixed(0)}% Conf.</span>
                    <span class="vuln-device">${v.deviceName} (${v.deviceMAC})</span>
                </div>
                <div class="vuln-details">
                    <p class="vuln-desc">${v.description}</p>
                    <div class="vuln-mitigation">
                        <strong>Mitigation:</strong> ${v.mitigation}
                    </div>
                    <div class="vuln-evidence">
                        <strong>Evidence:</strong> ${v.evidence.join(', ')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    getSeverityClass(severity) {
        if (severity >= 9) return 'critical';
        if (severity >= 7) return 'high';
        if (severity >= 5) return 'medium';
        return 'low';
    }

    toggle() {
        if (!this.container) this.createContainer();
        this.container.style.display = this.container.style.display === 'none' ? 'block' : 'none';
    }
}
