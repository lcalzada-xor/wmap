import { API } from '../core/api.js';
import { EventBus } from '../core/event_bus.js';
import { Notifications } from './notifications.js';

/**
 * Vulnerability Panel 3.0 (Master-Detail Layout)
 * Redesigned for iOS 19 Glassmorphism and high utility.
 */
export class VulnerabilityPanel {
    constructor() {
        this.container = null;
        this.vulns = [];
        this.filteredVulns = [];

        // State
        this.selectedVulnId = null;
        this.filters = {
            status: 'active', // 'active', 'ignored', 'fixed', 'all'
            min_severity: 0,
            search: ''
        };
        this.sort = {
            by: 'severity', // 'severity', 'time', 'name'
            order: 'desc' // 'asc', 'desc'
        };

        this.loading = false;

        // Real-Time Subscription
        EventBus.on('vulnerability:new', (vuln) => this.onNewVulnerability(vuln));
    }

    /**
     * Toggles the panel visibility
     */
    toggle() {
        if (!this.overlay) this.createContainer();

        const isVisible = this.overlay.style.display !== 'none';

        if (isVisible) {
            // Close
            this.container.classList.remove('pop-in');
            setTimeout(() => {
                this.overlay.style.display = 'none';
            }, 300); // Wait for animation
        } else {
            // Open
            this.overlay.style.display = 'flex';

            // Animation trigger
            requestAnimationFrame(() => {
                this.container.classList.add('pop-in');
            });

            this.fetchVulnerabilities();
        }
    }

    async fetchVulnerabilities() {
        this.loading = true;
        // this.renderList(true); // Show loading skeleton if implemented

        try {
            const apiFilters = {};
            if (this.filters.status !== 'all') apiFilters.status = this.filters.status;
            if (this.filters.min_severity > 0) apiFilters.min_severity = this.filters.min_severity;

            const data = await API.getVulnerabilities(apiFilters);
            this.vulns = data || [];

            // Apply local logic (search) and sort
            this.processData();

            // Select first item if nothing selected and items exist
            if (!this.selectedVulnId && this.filteredVulns.length > 0) {
                this.selectedVulnId = this.filteredVulns[0].ID;
            }

            this.render();

        } catch (err) {
            console.error("Failed to fetch vulns:", err);
            this.vulns = [];
            this.processData();
            this.render();
        } finally {
            this.loading = false;
        }
    }

    processData() {
        // 1. Filter locally check for search (backend might do status/severity)
        let res = this.vulns.filter(v => {
            const matchesSearch = v.Name.toLowerCase().includes(this.filters.search) ||
                (v.Description && v.Description.toLowerCase().includes(this.filters.search));

            // Double check status/severity if API didn't strict filter or if we want client side responsiveness
            const matchesStatus = this.filters.status === 'all' || v.Status === this.filters.status || (this.filters.status === 'active' && v.Status === 'new');
            const matchesSeverity = v.Severity >= this.filters.min_severity;

            return matchesSearch && matchesStatus && matchesSeverity;
        });

        // 2. Sort
        res.sort((a, b) => {
            let valA, valB;

            if (this.sort.by === 'severity') {
                valA = a.Severity;
                valB = b.Severity;
            } else if (this.sort.by === 'time') {
                valA = new Date(a.DetectedAt).getTime();
                valB = new Date(b.DetectedAt).getTime();
            } else {
                valA = a.Name;
                valB = b.Name;
            }

            if (valA < valB) return this.sort.order === 'asc' ? -1 : 1;
            if (valA > valB) return this.sort.order === 'asc' ? 1 : -1;
            return 0;
        });

        this.filteredVulns = res;
    }

    onNewVulnerability(vuln) {
        // Add to main list
        // Check if exists
        const idx = this.vulns.findIndex(v => v.ID === vuln.ID);
        if (idx !== -1) {
            this.vulns[idx] = vuln;
        } else {
            this.vulns.unshift(vuln);
            Notifications.show(`New Vulnerability: ${vuln.Name}`, 'warning');
        }

        this.processData();
        this.renderList(); // Re-render list to show new item
    }

    /* ---------------- UI Construction ---------------- */

    createContainer() {
        this.overlay = document.createElement('div');
        this.overlay.className = 'glass-modal-overlay-main';
        this.overlay.style.display = 'none';

        // Split View Container
        this.container = document.createElement('div');
        this.container.id = 'vulnerability-panel';

        // --- Sidebar (Left) ---
        const sidebar = document.createElement('div');
        sidebar.className = 'vuln-sidebar';
        sidebar.innerHTML = `
            <div class="sidebar-header">
                <div class="sidebar-title"><i class="fas fa-shield-virus" style="color:var(--accent-color)"></i> Findings</div>
                
                <div class="sidebar-controls">
                    <div class="search-wrapper-compact">
                        <i class="fas fa-search"></i>
                        <input type="text" id="vuln-search-input" class="glass-input-compact" placeholder="Search...">
                    </div>
                    <div class="filter-row-compact">
                        <select id="vuln-filter-status" class="glass-select-compact">
                            <option value="active">Active</option>
                            <option value="all">All Status</option>
                            <option value="ignored">Ignored</option>
                            <option value="fixed">Fixed</option>
                        </select>
                        <select id="vuln-sort-mode" class="glass-select-compact">
                            <option value="severity:desc">Highest Risk</option>
                            <option value="time:desc">Newest</option>
                            <option value="name:asc">A-Z</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="vuln-list-container" id="vuln-list-scroll">
                <!-- List Items Injected Here -->
            </div>
        `;

        // --- Detail View (Right) ---
        const detailView = document.createElement('div');
        detailView.className = 'vuln-detail-view';
        detailView.innerHTML = `
            <button class="close-panel-btn"><i class="fas fa-times"></i></button>
            <div id="vuln-detail-content" style="height:100%; display:flex; flex-direction:column;">
                <!-- Detail Content Injected Here -->
            </div>
        `;

        this.container.appendChild(sidebar);
        this.container.appendChild(detailView);
        this.overlay.appendChild(this.container);
        document.body.appendChild(this.overlay);

        this.bindEvents();
    }

    bindEvents() {
        // Close
        this.container.querySelector('.close-panel-btn').onclick = () => this.toggle();
        this.overlay.onclick = (e) => {
            if (e.target === this.overlay) this.toggle();
        };

        // Inputs
        const searchInput = this.container.querySelector('#vuln-search-input');
        searchInput.oninput = (e) => {
            this.filters.search = e.target.value.toLowerCase();
            this.processData();
            this.renderList();
        };

        const statusSelect = this.container.querySelector('#vuln-filter-status');
        statusSelect.onchange = (e) => {
            this.filters.status = e.target.value;
            this.fetchVulnerabilities(); // Re-fetch for status changes usually good
        };

        const sortSelect = this.container.querySelector('#vuln-sort-mode');
        sortSelect.onchange = (e) => {
            const [by, order] = e.target.value.split(':');
            this.sort.by = by;
            this.sort.order = order;
            this.processData();
            this.renderList();
        };
    }

    /* ---------------- Rendering ---------------- */

    render() {
        if (!this.container) return;
        this.renderList();
        this.renderDetail();
    }

    renderList() {
        const listContainer = this.container.querySelector('#vuln-list-scroll');
        listContainer.innerHTML = '';

        if (this.filteredVulns.length === 0) {
            listContainer.innerHTML = `<div style="padding:20px; text-align:center; color:rgba(255,255,255,0.3); font-size:0.9rem;">No findings match your filters.</div>`;
            return;
        }

        this.filteredVulns.forEach(vuln => {
            const el = document.createElement('div');
            el.className = `vuln-list-item ${this.selectedVulnId === vuln.ID ? 'selected' : ''}`;
            el.onclick = () => {
                this.selectedVulnId = vuln.ID;
                this.renderList(); // Update selection state
                this.renderDetail();
            };

            const severityClass = this.getSeverityClass(vuln.Severity);
            const statusBadge = vuln.Status !== 'active' && vuln.Status !== 'new'
                ? `<span class="status-badge-mini ${vuln.Status}">${vuln.Status}</span>`
                : '';

            el.innerHTML = `
                <div class="list-item-header">
                    <span class="list-item-title">${vuln.Name}</span>
                    <span class="severity-dot ${severityClass}"></span>
                </div>
                <div class="list-item-meta">
                    ${statusBadge}
                    <span><i class="fas fa-desktop"></i> ${vuln.TargetID ? vuln.TargetID.substring(0, 8) + '...' : 'Unknown'}</span>
                    <span style="margin-left:auto; font-size:0.75em; opacity:0.7;">${this.formatTime(vuln.DetectedAt)}</span>
                </div>
            `;
            listContainer.appendChild(el);
        });
    }

    renderDetail() {
        const detailContainer = this.container.querySelector('#vuln-detail-content');

        // Find selected vuln
        const vuln = this.filteredVulns.find(v => v.ID === this.selectedVulnId);

        if (!vuln) {
            detailContainer.innerHTML = `
                <div class="detail-empty-state">
                    <i class="fas fa-shield-alt"></i>
                    <h3>Select a Finding</h3>
                    <p>Choose a vulnerability from the sidebar to view details.</p>
                </div>
            `;
            return;
        }

        const severityLabel = this.getSeverityLabel(vuln.Severity);
        const severityClass = this.getSeverityClass(vuln.Severity);

        detailContainer.innerHTML = `
            <div class="detail-header">
                <div class="detail-title-group">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span class="status-badge-mini" style="background:${this.getSeverityColor(vuln.Severity)}; color:#000;">${severityLabel} (${vuln.Severity}/10)</span>
                        <span style="font-size:0.8rem; color:rgba(255,255,255,0.4); text-transform:uppercase;">${vuln.Category || 'General Disarray'}</span>
                    </div>
                    <h2>${vuln.Name}</h2>
                    <div class="detail-meta-row">
                        <span><i class="fas fa-desktop"></i> Target: <strong style="color:white; font-family:var(--font-mono);">${vuln.TargetID || 'N/A'}</strong></span>
                        <span><i class="fas fa-clock"></i> Detected: ${new Date(vuln.DetectedAt).toLocaleString()}</span>
                    </div>
                </div>
                <div class="detail-actions">
                    <button class="action-btn-glass" id="btn-vuln-ignore" title="Mark as Ignored/False Positive">
                        <i class="fas fa-eye-slash"></i> Ignore
                    </button>
                    ${vuln.Status === 'fixed' ? '' : `
                    <button class="action-btn-glass primary" id="btn-vuln-fix" title="Mark as Fixed">
                        <i class="fas fa-check"></i> Resolved
                    </button>`}
                </div>
            </div>
            
            <div class="detail-content">
                <div class="detail-section">
                    <h4>Description</h4>
                    <p style="line-height:1.6; color:rgba(255,255,255,0.8);">${vuln.Description || 'No description provided.'}</p>
                </div>

                <div class="detail-section">
                    <h4>Technical Evidence</h4>
                    <div class="info-grid">
                        <div class="info-item">
                             <label>CVSS Score</label>
                             <span>${vuln.CVSS || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                             <label>Discovery Source</label>
                             <span>${vuln.SourceModule || 'Scanner'}</span>
                        </div>
                    </div>
                </div>

                ${vuln.Evidence ? `
                <div class="detail-section">
                    <h4>Raw Evidence / Logs</h4>
                    <pre class="code-block">${vuln.Evidence}</pre>
                </div>` : ''}

                ${vuln.Remediation ? `
                <div class="detail-section" style="background:rgba(48, 209, 88, 0.05); border-color:rgba(48, 209, 88, 0.2);">
                    <h4 style="color:#30d158;">Remediation</h4>
                    <p style="color:rgba(255,255,255,0.9);">${vuln.Remediation}</p>
                </div>` : ''}
            </div>
        `;

        // Bind Action Buttons
        const btnIgnore = detailContainer.querySelector('#btn-vuln-ignore');
        if (btnIgnore) btnIgnore.onclick = () => this.handleStatusChange(vuln.ID, 'ignored');

        const btnFix = detailContainer.querySelector('#btn-vuln-fix');
        if (btnFix) btnFix.onclick = () => this.handleStatusChange(vuln.ID, 'fixed');
    }

    /* ---------------- Helpers ---------------- */

    async handleStatusChange(id, status) {
        if (!confirm(`Mark this finding as ${status}?`)) return;

        try {
            await API.updateVulnerabilityStatus(id, status); // Assume this method exists or needs creating
            // Optimistic update
            const v = this.vulns.find(x => x.ID === id);
            if (v) v.Status = status;

            Notifications.show(`Vulnerability marked as ${status}`, 'success');

            // Re-process to respect filters
            this.processData();
            this.render();
        } catch (e) {
            console.error(e);
            Notifications.show("Failed to update status", 'error');
        }
    }

    getSeverityClass(score) {
        if (score >= 9.0) return 'critical';
        if (score >= 7.0) return 'high';
        if (score >= 4.0) return 'medium';
        return 'low';
    }

    getSeverityLabel(score) {
        if (score >= 9.0) return 'Critical';
        if (score >= 7.0) return 'High';
        if (score >= 4.0) return 'Medium';
        return 'Low';
    }

    getSeverityColor(score) {
        if (score >= 9.0) return '#ff453a';
        if (score >= 7.0) return '#ff9f0a';
        if (score >= 4.0) return '#0a84ff';
        return '#30d158';
    }

    formatTime(isoString) {
        const d = new Date(isoString);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}
