package handlers

import (
	"encoding/json"
	"net/http"
	"strconv"

	"github.com/lcalzada-xor/wmap/internal/core/domain"
	"github.com/lcalzada-xor/wmap/internal/core/services/security"
)

type VulnerabilityHandler struct {
	service *security.VulnerabilityPersistenceService
}

func NewVulnerabilityHandler(service *security.VulnerabilityPersistenceService) *VulnerabilityHandler {
	return &VulnerabilityHandler{
		service: service,
	}
}

// GetVulnerabilities returns a list of vulnerabilities.
// Query Params: device_mac, status (active, ignored, fixed), min_severity
func (h *VulnerabilityHandler) GetVulnerabilities(w http.ResponseWriter, r *http.Request) {
	mac := r.URL.Query().Get("device_mac")
	statusStr := r.URL.Query().Get("status")
	severityStr := r.URL.Query().Get("min_severity")

	var status *domain.VulnerabilityStatus
	if statusStr != "" {
		s := domain.VulnerabilityStatus(statusStr)
		status = &s
	}

	minSeverity := 0
	if severityStr != "" {
		minSeverity, _ = strconv.Atoi(severityStr)
	}

	filter := domain.VulnerabilityFilter{
		DeviceMAC:   mac,
		Status:      status,
		MinSeverity: minSeverity,
	}

	vulns, err := h.service.GetVulnerabilities(filter)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(vulns)
}

// UpdateStatus updates the status of a vulnerability.
// PUT /api/vulnerabilities/{id}/status
// Body: { "status": "ignored" }
func (h *VulnerabilityHandler) UpdateStatus(w http.ResponseWriter, r *http.Request) {
	id := r.PathValue("id")
	if id == "" {
		http.Error(w, "ID required", http.StatusBadRequest)
		return
	}

	var req struct {
		Status string `json:"status"`
		Notes  string `json:"notes"`
	}
	if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
		http.Error(w, "Invalid body", http.StatusBadRequest)
		return
	}

	if req.Status == "" {
		http.Error(w, "Status required", http.StatusBadRequest)
		return
	}

	status := domain.VulnerabilityStatus(req.Status)
	// Validate status
	if status != domain.VulnStatusActive && status != domain.VulnStatusIgnored && status != domain.VulnStatusFixed {
		http.Error(w, "Invalid status", http.StatusBadRequest)
		return
	}

	if err := h.service.UpdateStatus(id, status, req.Notes); err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	w.WriteHeader(http.StatusOK)
}
